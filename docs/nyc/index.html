<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CivicPulse — New York NY</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        --background: #ffffff;
        --foreground: #111111;
        --accent: #c37b33;
        --border: #000000;
        --muted: #555555;
        --accent2: #1F3A5F;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--background);
        color: var(--foreground);
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 16px;
        line-height: 1.6;
      }

      .wrap {
        max-width: 960px;
        margin: 0 auto;
        padding: 32px 20px 56px;
      }

      /* Masthead */
      header {
        margin-bottom: 32px;
      }

      .masthead-top {
        display: flex;
        justify-content: space-between;
        gap: 16px;
        font-size: 13px;
        color: #444444;
        margin-bottom: 10px;
      }

      h1 {
        margin: 0 0 12px;
        font-size: 44px;
        font-weight: 600;
        text-align: center;
        letter-spacing: 0.01em;
      }

      .word-civic {
        color: #000000;
      }

      .word-pulse {
        color: var(--accent);
      }

      .place-label {
        padding: 2px 10px;
        border: 1px solid var(--border);
        font-size: 14px;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      nav.nav-row {
        display: flex;
        justify-content: center;
        gap: 28px;
        margin: 0;
        font-size: 13px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .nav-row a {
        color: var(--border);
        text-decoration: none;
      }

      .nav-row a.active {
        font-weight: 600;
      }

      /* Daily fact */
      .daily-fact {
        margin: 26px 0 36px;
        font-size: 18px;
        line-height: 1.5;
      }

      .daily-fact strong {
        display: inline-block;
        margin-right: 10px;
        font-size: 1em;
        letter-spacing: 0.1em;
        text-transform: uppercase;
      }

      .topline {
        margin: 20px 0;
        padding: 16px;
        background: #f8f9fa;
        border-left: 3px solid var(--accent);
        font-size: 16px;
        line-height: 1.5;
      }

      #topline {
        display: inline;
      }

      #topline a {
        color: inherit;
      }

      /* Featured grid */
      .featured-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px;
      }

      .featured-card {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 20px;
        border: 1px solid var(--border);
        background: var(--background);
      }

      .featured-card h3 {
        margin: 0;
        font-size: 13px;
        letter-spacing: 0.1em;
        text-transform: uppercase;
      }

      .featured-body {
        font-size: 15px;
      }

      .featured-body a {
        text-decoration: none;
        color: var(--accent2);
      }

      .featured-body a:hover {
        text-decoration: underline;
      }

      .daily-fact a {
        text-decoration: none;
        color: var(--accent2);
      }

      .daily-fact a:hover {
        text-decoration: underline;
      }

      .muted {
        margin-top: auto;
        font-size: 12px;
        color: var(--muted);
      }

      /* Poll styles */
      .poll-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 32px;
        border: 1px solid var(--border);
      }

      .poll-question {
        font-size: 20px;
        font-weight: 600;
        margin: 0 0 24px;
      }

      .poll-options {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 24px;
      }

      .poll-option input[type="radio"] {
        position: absolute;
        opacity: 0;
      }

      .poll-option label {
        display: block;
        padding: 16px 20px;
        border: 2px solid var(--border);
        cursor: pointer;
      }

      .poll-option input[type="radio"]:checked + label {
        background: var(--accent2);
        color: white;
        border-color: var(--accent2);
      }

      .poll-submit {
        width: 100%;
        padding: 14px 24px;
        background: var(--accent);
        color: white;
        border: none;
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        cursor: pointer;
      }

      .poll-submit:disabled {
        background: var(--muted);
        cursor: not-allowed;
      }

      .success-message {
        display: none;
        padding: 20px;
        background: #e8f5e9;
        border: 2px solid #4caf50;
        color: #2e7d32;
        text-align: center;
        font-weight: 600;
        margin-top: 20px;
      }

      .success-message.show {
        display: block;
      }

      /* Footer */
      .footer-note {
        margin-top: 40px;
        font-size: 14px;
        text-align: right;
      }

      .footer-note a {
        color: var(--border);
        text-decoration: none;
      }

      .footer-note a:hover {
        text-decoration: underline;
      }

      @media (max-width: 600px) {
        .wrap {
          padding: 24px 16px 40px;
        }

        .masthead-top {
          flex-direction: column;
          align-items: flex-start;
        }

        h1 {
          font-size: 36px;
        }

        .featured-grid {
          grid-template-columns: 1fr;
        }

        .daily-fact {
          margin: 22px 0 28px;
          font-size: 17px;
        }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <header>
        <div class="masthead-top">
          <div>Last Updated <span id="updated">—</span></div>
          <div class="place-label" id="place">—</div>
        </div>
        <h1>
          <span class="word-civic">Civic</span><span class="word-pulse">Pulse</span>
        </h1>
        <nav class="nav-row" aria-label="Primary">
          <a href="#pulse" id="nav-pulse">Daily Pulse</a>
          <!-- <a href="#poll" id="nav-poll">Daily Poll</a> -->
          <!-- <a href="#">Forum</a>
          <a href="#">Games</a> -->
        </nav>
      </header>

      <main>
        <p class="daily-fact" id="daily-fact">
          <strong>Daily Fact:</strong>
          <span id="daily-fact-content">Loading…</span>
        </p>

        <section class="featured-grid" id="featured" aria-label="Featured civic updates"></section>
      </main>

      <footer class="footer-note">
        <a href="https://forms.gle/y4knwDwoe8aeJXS2A">Send us your feedback</a>
      </footer>
    </div>

    <script>
      "use strict";

      const DIGEST_PATH = "civicpulse_digest_New_York_NY.json";

      const featuredGroups = [
        { label: "Risks / Alerts", keys: ["risks_alerts"] },
        { label: "Civics / Politics", keys: ["civics_politics"] },
        { label: "Opportunities / Welfare", keys: ["opportunities_welfare"] },
        { label: "Community", keys: ["community"] }
      ];

      const elements = {
        place: document.getElementById("place"),
        updated: document.getElementById("updated"),
        dailyFact: document.getElementById("daily-fact-content"),
        featured: document.getElementById("featured")
      };

      function mdToHtml(markdown = "") {
        return markdown
          .replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
          .replace(/\n/g, "<br/>");
      }

      function getSectionSummary(section) {
        if (!section) {
          return null;
        }

        if (section.summary_md) {
          const clean = section.summary_md.replace(/^#+\s*[^\n]+\n*/, "");
          return { html: mdToHtml(clean), title: section.title || "" };
        }

        if (Array.isArray(section.items) && section.items.length > 0) {
          return { html: mdToHtml(section.items[0]), title: section.title || "" };
        }

        return null;
      }

      function findSummary(group, sections) {
        for (const key of group.keys) {
          const summary = getSectionSummary(sections[key]);
          if (summary) {
            return summary;
          }
        }

        return { html: "No updates available right now.", title: "" };
      }

      function renderFeatured(sections) {
        elements.featured.replaceChildren();

        featuredGroups.forEach(group => {
          const { html, title } = findSummary(group, sections);
          const card = document.createElement("article");
          card.className = "featured-card";
          card.innerHTML = `
            <h3>${group.label}</h3>
            <div class="featured-body">${html}</div>
          `;
          elements.featured.append(card);
        });
      }

      function formatGeneratedAt(generatedAt) {
        if (!generatedAt) {
          return "—";
        }

        const generated = new Date(generatedAt);
        const datePart = generated.toLocaleDateString(undefined, {
          month: "numeric",
          day: "numeric"
        });
        const timePart = generated.toLocaleTimeString(undefined, {
          hour: "numeric",
          minute: "2-digit"
        });

        return `${datePart} at ${timePart}`;
      }

      async function loadDigest() {
        const response = await fetch(DIGEST_PATH);
        if (!response.ok) {
          throw new Error(`Failed to fetch digest: ${response.status}`);
        }

        return response.json();
      }

      async function initialisePage() {
        try {
          const data = await loadDigest();
          elements.place.textContent = data.place || "Essentials District";
          elements.updated.textContent = formatGeneratedAt(data.generated_at_utc);
          elements.dailyFact.innerHTML = mdToHtml(data.daily_fact || "No daily fact available today.");

          const sections = data.sections || {};
          renderFeatured(sections);
        } catch (error) {
          console.error("Failed to load data:", error);
          elements.topline.textContent = "Failed to load data. Please try again later.";
        }
      }

      // Get today's question based on day of week
      function getTodaysQuestion(pollData) {
        const dayOfWeek = new Date().getDay(); // 0=Sunday, 1=Monday, ..., 6=Saturday
        
        // Find question for today
        const question = pollData.questions.find(q => 
          q.active_days && q.active_days.includes(dayOfWeek)
        );
        
        // Fallback to first question if none match
        return question || pollData.questions[0];
      }

      // Load and display poll
      async function showPoll() {
        try {
          // Load poll questions
          const response = await fetch('poll-questions.json');
          const pollData = await response.json();
          const question = getTodaysQuestion(pollData);
          
          // Build options HTML
          const optionsHTML = question.options.map((option, index) => `
            <div class="poll-option">
              <input type="radio" id="option${index + 1}" name="poll_response" value="${option}" required />
              <label for="option${index + 1}">${option}</label>
            </div>
          `).join('');
          
          // Render poll
          const main = document.querySelector("main");
          main.innerHTML = `
            <div class="poll-container">
              <h2 class="poll-question">${question.question}</h2>
              <form id="poll-form" action="https://formspree.io/f/YOUR_FORM_ID" method="POST">
                <div class="poll-options">
                  ${optionsHTML}
                </div>
                <input type="hidden" name="poll_date" id="poll_date" />
                <input type="hidden" name="poll_id" value="${question.id}" />
                <input type="hidden" name="_subject" value="CivicPulse Daily Poll Response" />
                <button type="submit" class="poll-submit" id="submit-btn">Submit Vote</button>
              </form>
              <div class="success-message" id="success-message">
                ✓ Thank you for voting! Your response has been recorded.
              </div>
            </div>
          `;

          initPollForm();
        } catch (error) {
          console.error('Failed to load poll:', error);
          const main = document.querySelector("main");
          main.innerHTML = '<div class="poll-container"><p>Unable to load poll. Please try again later.</p></div>';
        }
      }

      function initPollForm() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('poll_date').value = today;

        const lastVoteDate = localStorage.getItem('civicpulse_last_vote');
        const form = document.getElementById('poll-form');
        const submitBtn = document.getElementById('submit-btn');
        const successMessage = document.getElementById('success-message');

        if (lastVoteDate === today) {
          submitBtn.disabled = true;
          submitBtn.textContent = "You've already voted today";
          successMessage.textContent = "You've already submitted your vote for today. Come back tomorrow!";
          successMessage.classList.add('show');
        }

        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          const formData = new FormData(form);
          
          try {
            submitBtn.disabled = true;
            submitBtn.textContent = "Submitting...";

            const response = await fetch(form.action, {
              method: 'POST',
              body: formData,
              headers: { 'Accept': 'application/json' }
            });

            if (response.ok) {
              localStorage.setItem('civicpulse_last_vote', today);
              form.style.display = 'none';
              successMessage.classList.add('show');
            } else {
              throw new Error('Form submission failed');
            }
          } catch (error) {
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit Vote";
            alert('There was an error submitting your vote. Please try again.');
          }
        });
      }

      function updateNav() {
        const navPulse = document.getElementById('nav-pulse');
        const navPoll = document.getElementById('nav-poll');
        
        // If poll nav doesn't exist, just make pulse active
        if (!navPoll) {
          if (navPulse) navPulse.classList.add('active');
          return;
        }
        
        if (window.location.hash === '#poll') {
          navPulse.classList.remove('active');
          navPoll.classList.add('active');
        } else {
          navPulse.classList.add('active');
          navPoll.classList.remove('active');
        }
      }

      function route() {
        updateNav();
        
        if (window.location.hash === '#poll') {
          const pollNav = document.getElementById('nav-poll');
          if (!pollNav) {
            // Poll is disabled, redirect to pulse
            window.location.hash = '#pulse';
            return;
          }
          showPoll();
        } else {
          // Show digest (for #home, #, or no hash)
          const main = document.querySelector("main");
          main.innerHTML = `
            <p class="daily-fact" id="daily-fact">
              <strong>Daily Fact:</strong>
              <span id="daily-fact-content">Loading…</span>
            </p>
            <section class="featured-grid" id="featured" aria-label="Featured civic updates"></section>
          `;
          
          // Re-assign elements after DOM update
          elements.dailyFact = document.getElementById("daily-fact-content");
          elements.featured = document.getElementById("featured");
          
          initialisePage();
        }
      }

      window.addEventListener('hashchange', route);
      route();
    </script>
  </body>
</html>
